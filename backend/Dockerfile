# Dockerfile
FROM node:18

WORKDIR /app

# Copia apenas os arquivos de depend√™ncia primeiro para usar o cache de build
COPY package*.json ./

# Instala depend√™ncias (inclui @prisma/client e prisma)
RUN npm install

# Copia o restante do c√≥digo
COPY . .

# Gera o Prisma Client (necess√°rio para rodar depois)
RUN npx prisma generate

# Compila o projeto TypeScript
RUN npm run build

# Exp√µe a porta (ajuste se necess√°rio)
EXPOSE 3000

# Cria script de inicializa√ß√£o que configura o banco e depois inicia o servidor
RUN echo '#!/bin/bash\necho "üóÑÔ∏è Setting up database..."\nnpx prisma db push --accept-data-loss\necho "‚úÖ Database ready!"\necho "üöÄ Starting server..."\nnode dist/server.js' > /app/start.sh
RUN chmod +x /app/start.sh

# Inicia com o script que roda migra√ß√µes primeiro
CMD ["/app/start.sh"]
